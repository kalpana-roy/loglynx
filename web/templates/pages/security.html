{{define "security.html"}}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}} - LogLynx</title>

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/static/images/favicon.svg">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="/static/css/theme.css" rel="stylesheet">
    <link href="/static/css/layout.css" rel="stylesheet">
    <link href="/static/css/charts.css" rel="stylesheet">
    <link href="/static/css/tooltip.css" rel="stylesheet">
</head>
<body>
    <div class="app-container">
        {{template "sidebar" .}}
        <div class="sidebar-overlay"></div>
        <div class="main-content">
            {{template "header" .}}
            <main class="page-content">
<div class="page-header">
    <div class="page-header-top">
        <div>
            <h2 class="page-title">
                <i class="fas fa-shield-alt"></i>
                Security & Network
            </h2>
            <p class="page-description">Security metrics, IP reputation, and network analysis</p>
        </div>
        <div class="page-actions">
            <button class="btn btn-outline btn-sm" onclick="exportSecurityReport()">
                <i class="fas fa-file-export"></i> Export Report
            </button>
            <button class="btn btn-outline btn-sm" onclick="location.reload()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </div>
</div>

<!-- Security Summary KPIs -->
<div class="grid grid-cols-4 mb-4">
    <div class="stat-card">
        <div class="stat-label">Total Requests</div>
        <div class="stat-value" id="totalRequests">0</div>
        <div class="stat-subtitle">Last 7 days</div>
    </div>

    <div class="stat-card">
        <div class="stat-label">Failed Requests</div>
        <div class="stat-value text-danger" id="failedRequests">0</div>
        <div class="stat-subtitle">4xx & 5xx errors</div>
    </div>

    <div class="stat-card">
        <div class="stat-label">Unique IPs</div>
        <div class="stat-value text-info" id="uniqueIPs">0</div>
        <div class="stat-subtitle">IP addresses</div>
    </div>

    <div class="stat-card">
        <div class="stat-label">Countries</div>
        <div class="stat-value text-success" id="totalCountries">0</div>
        <div class="stat-subtitle">Geographic sources</div>
    </div>
</div>

<!-- Status Code Distribution -->
<div class="chart-grid two-column mb-4">
    <div class="chart-container medium">
        <div class="chart-header">
            <div>
                <h5 class="chart-title">
                    <i class="fas fa-chart-pie"></i>
                    Status Code Distribution
                </h5>
                <p class="chart-subtitle">Response status codes</p>
            </div>
        </div>
        <canvas id="statusCodeChart"></canvas>
    </div>

    <div class="chart-container medium">
        <div class="chart-header">
            <div>
                <h5 class="chart-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    Error Timeline
                </h5>
                <p class="chart-subtitle">4xx and 5xx errors over time</p>
            </div>
        </div>
        <canvas id="errorTimelineChart"></canvas>
    </div>
</div>

<!-- Protocol and TLS Analysis -->
<div class="chart-grid two-column mb-4">
    <div class="chart-container medium">
        <div class="chart-header">
            <div>
                <h5 class="chart-title">
                    <i class="fas fa-network-wired"></i>
                    Protocol Distribution
                </h5>
                <p class="chart-subtitle">HTTP protocol versions</p>
            </div>
        </div>
        <canvas id="protocolChart"></canvas>
    </div>

    <div class="chart-container medium">
        <div class="chart-header">
            <div>
                <h5 class="chart-title">
                    <i class="fas fa-lock"></i>
                    TLS Version Distribution
                </h5>
                <p class="chart-subtitle">SSL/TLS protocol versions</p>
            </div>
        </div>
        <canvas id="tlsVersionChart"></canvas>
    </div>
</div>

<!-- Top IPs Table -->
<div class="table-container mb-4">
    <div class="table-header">
        <h5 class="table-title">
            <i class="fas fa-network-wired"></i>
            Top IP Addresses
        </h5>
        <p class="table-subtitle">Most active IP addresses</p>
    </div>
    <table id="topIPsTable" class="table table-hover">
        <thead>
            <tr>
                <th>IP Address</th>
                <th>Country</th>
                <th>Requests</th>
                <th>Bandwidth</th>
                <th>Avg Response</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

<!-- Top Countries Table -->
<div class="table-container mb-4">
    <div class="table-header">
        <h5 class="table-title">
            <i class="fas fa-globe"></i>
            Top Countries
        </h5>
        <p class="table-subtitle">Traffic by country</p>
    </div>
    <table id="topCountriesTable" class="table table-hover">
        <thead>
            <tr>
                <th>Country</th>
                <th>Requests</th>
                <th>Unique IPs</th>
                <th>Bandwidth</th>
                <th>Percentage</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

            </main>
            {{template "footer" .}}
        </div>
    </div>

    {{template "scripts-common" .}}

    <script src="/static/js/core/country-data.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            LogLynxUtils.setActiveNavItem('security');

            // Initialize DataTables
            const topIPsTable = $('#topIPsTable').DataTable({
                ajax: {
                    url: LogLynxAPI.buildURL('/stats/top/ips', { limit: 50 }),
                    dataSrc: ''
                },
                columns: [
                    { data: 'ip_address' },
                    { data: 'country', defaultContent: '-' },
                    { data: 'hits', render: (data) => data.toLocaleString() },
                    { data: 'bandwidth', render: (data) => LogLynxUtils.formatBytes(data) },
                    { data: null, render: () => '-', defaultContent: '-' },
                    { data: null, render: () => '<span class="badge badge-success">OK</span>', defaultContent: '<span class="badge badge-success">OK</span>' }
                ],
                order: [[2, 'desc']],
                pageLength: 20
            });

            const topCountriesTable = $('#topCountriesTable').DataTable({
                ajax: {
                    url: LogLynxAPI.buildURL('/stats/top/countries', { limit: 20 }),
                    dataSrc: ''
                },
                columns: [
                    {
                        data: 'country',
                        defaultContent: 'Unknown',
                        render: (data, type, row) => {
                            if (!data) return 'Unknown';
                            const countryName = row.country_name || data;
                            return `${countryCodeToFlag(data, data)} ${countryName}`;
                        }
                    },
                    { 
                        data: 'hits', 
                        defaultContent: '0', 
                        render: (data) => (data || 0).toLocaleString() 
                    },
                    { 
                        data: 'unique_visitors', 
                        defaultContent: '0', 
                        render: (data) => (data || 0).toLocaleString() 
                    },
                    { 
                        data: 'bandwidth', 
                        defaultContent: '0', 
                        render: (data) => LogLynxUtils.formatBytes(data || 0) 
                    },
                    {
                        data: null,
                        defaultContent: '-',
                        orderable: false,
                        render: (data, type, row) => {
                            return '-';
                        }
                    }
                ],
                order: [[1, 'desc']],
                pageLength: 15,
                language: {
                    emptyTable: 'No country data available',
                    zeroRecords: 'No countries found',
                    loadingRecords: 'Loading...'
                }
            });

            // Load status code distribution
            fetch(LogLynxAPI.buildURL('/stats/distribution/status-codes'))
                .then(response => response.json())
                .then(data => {
                    const ctx = document.getElementById('statusCodeChart');
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: data.map(item => `${item.status_code} (${item.count.toLocaleString()})`),
                            datasets: [{
                                data: data.map(item => item.count),
                                backgroundColor: data.map(item => {
                                    const code = parseInt(item.status_code);
                                    if (code < 300) return '#28a745';
                                    if (code < 400) return '#17a2b8';
                                    if (code < 500) return '#ffc107';
                                    return '#dc3545';
                                })
                            }]
                        },
                        options: LogLynxCharts.defaultOptions
                    });
                });

            // Load error timeline
            fetch(LogLynxAPI.buildURL('/stats/timeline/status-codes', { hours: 168 }))
                .then(response => response.json())
                .then(data => {
                    const ctx = document.getElementById('errorTimelineChart');
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.map(item => item.hour),
                            datasets: [
                                {
                                    label: '4xx Errors',
                                    data: data.map(item => item.status_4xx || 0),
                                    borderColor: '#ffc107',
                                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                                    tension: 0.4
                                },
                                {
                                    label: '5xx Errors',
                                    data: data.map(item => item.status_5xx || 0),
                                    borderColor: '#dc3545',
                                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                                    tension: 0.4
                                }
                            ]
                        },
                        options: LogLynxCharts.defaultOptions
                    });
                });

            // Load protocol distribution
            fetch(LogLynxAPI.buildURL('/stats/distribution/protocols'))
                .then(response => response.json())
                .then(data => {
                    const ctx = document.getElementById('protocolChart');
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: data.map(item => item.protocol),
                            datasets: [{
                                label: 'Requests',
                                data: data.map(item => item.count),
                                backgroundColor: '#F46319'
                            }]
                        },
                        options: LogLynxCharts.defaultOptions
                    });
                });

            // Load TLS version distribution
            fetch(LogLynxAPI.buildURL('/stats/distribution/tls-versions'))
                .then(response => response.json())
                .then(data => {
                    const ctx = document.getElementById('tlsVersionChart');
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: data.map(item => item.tls_version || 'Unknown'),
                            datasets: [{
                                label: 'Requests',
                                data: data.map(item => item.count),
                                backgroundColor: '#17a2b8'
                            }]
                        },
                        options: LogLynxCharts.defaultOptions
                    });
                });

            // Load summary stats
            fetch(LogLynxAPI.buildURL('/stats/summary'))
                .then(response => response.json())
                .then(data => {
                    document.getElementById('totalRequests').textContent = data.total_requests.toLocaleString();
                    document.getElementById('failedRequests').textContent = data.failed_requests.toLocaleString();
                    document.getElementById('uniqueIPs').textContent = data.unique_visitors.toLocaleString();
                });

            // Load unique countries count
            fetch(LogLynxAPI.buildURL('/stats/top/countries', { limit: 1000 }))
                .then(response => response.json())
                .then(data => {
                    document.getElementById('totalCountries').textContent = data.length.toLocaleString();
                });
        });

        function exportSecurityReport() {
            alert('Export functionality coming soon!');
        }
    </script>
</body>
</html>
{{end}}
